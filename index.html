<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <title>MedScroll - Animations 3D M√©dicales Scientifiques</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #0a192f;
            color: #e6f1ff;
            overflow-x: hidden;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            max-width: 500px;
            height: 100vh;
            margin: 0 auto;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            background-color: #0a192f;
            box-shadow: 0 0 20px rgba(0, 150, 255, 0.2);
            overflow: hidden;
        }
        
        .header {
            position: fixed;
            top: 0;
            width: 100%;
            max-width: 500px;
            padding: 15px;
            background: rgba(10, 25, 47, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1e3a5c;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #64ffda;
        }
        
        .search-container {
            position: fixed;
            top: 60px;
            width: 100%;
            max-width: 500px;
            padding: 15px;
            background: rgba(10, 25, 47, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 999;
            border-bottom: 1px solid #1e3a5c;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        .search-input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 30px;
            border: 1px solid #1e3a5c;
            background-color: #112240;
            color: #e6f1ff;
            font-size: 1rem;
            outline: none;
        }
        
        .search-input:focus {
            border-color: #64ffda;
        }
        
        .videos-container {
            margin-top: 140px;
            height: calc(100vh - 140px);
            overflow-y: auto;
            scroll-snap-type: y mandatory;
            padding-bottom: 20px;
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        .video-card {
            height: calc(100vh - 140px);
            scroll-snap-align: start;
            position: relative;
            margin-bottom: 10px;
            border-radius: 10px;
            overflow: hidden;
            background-color: #112240;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-height: calc(100vh - 140px);
        }
        
        .video-wrapper {
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .video-player {
            flex-grow: 1;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .video-player iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 2;
            cursor: pointer;
        }
        
        .video-info {
            padding: 15px;
            background: rgba(17, 34, 64, 0.9);
            z-index: 3;
            position: relative;
        }
        
        .video-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .video-actions {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background: rgba(17, 34, 64, 0.9);
            z-index: 3;
            position: relative;
        }
        
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #8892b0;
            background: none;
            border: none;
            font-size: 0.8rem;
            cursor: pointer;
            transition: color 0.3s;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .action-btn i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .action-btn:hover {
            color: #64ffda;
            background: rgba(100, 255, 218, 0.1);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #64ffda;
        }
        
        .error-message {
            text-align: center;
            padding: 20px;
            color: #ff6b6b;
        }
        
        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #8892b0;
        }
        
        .cache-indicator {
            text-align: center;
            padding: 10px;
            font-size: 0.8rem;
            color: #64ffda;
            background: rgba(100, 255, 218, 0.1);
            margin: 10px 15px;
            border-radius: 8px;
            display: none;
        }
        
        .api-status {
            text-align: center;
            padding: 5px;
            font-size: 0.7rem;
            color: #8892b0;
            background: rgba(136, 146, 176, 0.1);
            margin: 5px 15px;
            border-radius: 5px;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            color: #64ffda;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            padding: 15px 0 0;
            overflow-x: auto;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #1e3a5c;
            background-color: #112240;
            color: #e6f1ff;
            font-size: 0.85rem;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background-color: #64ffda;
            color: #0a192f;
            border-color: #64ffda;
        }
        
        .quality-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
        }
        
        @media (max-width: 500px) {
            .app-container {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="logo">MedScroll</div>
            <button class="theme-toggle" id="themeToggle">üåô</button>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Rechercher des animations 3D m√©dicales scientifiques...">
            <div class="filters" id="filtersContainer">
                <!-- Les filtres seront g√©n√©r√©s par JavaScript -->
            </div>
        </div>
        
        <div class="cache-indicator" id="cacheIndicator">
            üì¶ Affichage de vid√©os al√©atoires depuis le cache
        </div>
        
        <div class="api-status" id="apiStatus">
            Cl√© API: #1 Active
        </div>
        
        <div class="videos-container" id="videosContainer">
            <div class="loading pulse" id="loadingIndicator">
                Chargement des vid√©os 3D scientifiques...
            </div>
        </div>
    </div>

    <script>
        // Syst√®me de rotation des cl√©s API
        const API_KEYS = [
            'AIzaSyA29N87URIVbARV6u7iFxwVkFE_HhBQ2do',
            'AIzaSyBv923jHil-jQXGwlQ1q0n_2U4npwjmS0Q',
            'AIzaSyDMQ_FPnH20Boszaa2nmF1tJK9ebAZZeZA',
            'AIzaSyAjzBXOmlmm8DIA09cmGm657bQy0BM4yH4',
            'AIzaSyBEYIB9E3h-L5hUJeb4YbNxBdz1qRtKt3o',
            'AIzaSyBPbO6vz9VNJTh0ChuTgkw1I79mDdM5Jz0',
            'AIzaSyA8iqyOyW23EBMPTyUDdc60Ktr4IgYKqOY',
            'AIzaSyDk0uy46P30eZ5-bHXxsN3mhfVV6l748kk',
            'AIzaSyASVLpfyJtd6JcykhFbt6otfvQ4bnKru18',
            'AIzaSyBGHppz5TzJsHzu_-QlvuPf1XDyXjIaeII',
            'AIzaSyAmDK1l3q8prV0G-ey66BTUwuL1zE1NVFA',
            'AIzaSyC-nC-EDN_jC9OEf1EeNvkA2_U54MJAQ5c',
            'AIzaSyAnqKEhjWjU9AdLYMTzajwL0zSeNOI4sqo',
            'AIzaSyAN777ZC0XqVVGMzDwtaTjOvHrkpw_AttI',
            'AIzaSyAYnSX2GuLRLr5jr8PhC04TVORaq3PYJMc',
            'AIzaSyA-9hxqqTU9gPgxWHofCUuWtIltWvOM1SI',
            'AIzaSyAbUjO5Xx06SEvEs4LXhX5IeJzMTIPWKx4',
            'AIzaSyBa8no-BkS6UToHqoxBuPsXwStsEIpm6IQ',
            'AIzaSyClw-ZhG0OZ2FLM0aV1ZJxpakJP5_CwkoA',
            'AIzaSyDynYQHcqS0EJVnYrmMyskHftfQDfKl8q4',
            'AIzaSyBfZLa5K0Iy4jZF136XhWBASpFe4vdFOPY',
            'AIzaSyBlBX1TNaDwKIWPq16dqCAN8tI-OhsXyfc',
            'AIzaSyDWR-FDtZYdMB1Fmbl4R-4NG_pZu3U6NIc',
            'AIzaSyBhkRhR-36xmScz8lklPjc5MGLlAEtGHbw',
            'AIzaSyDwZ-1ONaku6cm6wa8jrlnMF1pOf5NQpBo'
        ];
        
        // Variables globales
        let currentApiKeyIndex = 0;
        let currentTheme = 'dark';
        let nextPageToken = '';
        let isLoading = false;
        let currentQuery = '(3D medical animation OR "animation 3D m√©dicale") (science OR scientifique) -"real" -"actual" -"surgery" -"live" -"vlog" -"blog"';
        let currentVideoId = null;
        let watchedVideos = new Set();
        let allVideosCache = [];
        let isUsingCache = false;
        let apiErrorCount = 0;
        const MAX_API_ERRORS = 3;
        
        // √âl√©ments DOM
        const videosContainer = document.getElementById('videosContainer');
        const searchInput = document.getElementById('searchInput');
        const themeToggle = document.getElementById('themeToggle');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const filtersContainer = document.getElementById('filtersContainer');
        const cacheIndicator = document.getElementById('cacheIndicator');
        const apiStatus = document.getElementById('apiStatus');
        
        // Filtres optimis√©s pour animations 3D scientifiques
        const medicalFilters = [
    // ANATOMIE ET STRUCTURES (Bas√© sur "Anatomie maxillo-faciale")
    { name: 'Anatomie Maxillo-Faciale 3D', query: '(3D maxillofacial anatomy OR "anatomie maxillo-faciale 3D") animation' },
    { name: 'Ost√©ologie 3D', query: '(3D osteology OR "ost√©ologie 3D") bone anatomy animation' },
    { name: 'Myologie 3D', query: '(3D myology OR "myologie 3D") muscle anatomy animation' },
    { name: 'Arthrologie 3D', query: '(3D arthrology OR "arthrologie 3D") joint animation' },
    { name: 'Angiologie 3D', query: '(3D angiology OR "angiologie 3D") blood vessels animation' },
    { name: 'Cr√¢ne 3D', query: '(3D skull OR "cr√¢ne 3D") anatomy animation' },
    { name: 'Rachis 3D', query: '(3D spine OR "rachis 3D") vertebral column animation' },

    // BIOLOGIE FONDAMENTALE (Bas√© sur "Biologie v√©g√©tale" et "Biologie animale")
    { name: 'Biologie V√©g√©tale 3D', query: '(3D plant biology OR "biologie v√©g√©tale 3D") animation' },
    { name: 'Biologie Animale 3D', query: '(3D animal biology OR "biologie animale 3D") animation' },
    { name: 'Histologie 3D', query: '(3D histology OR "histologie 3D") tissue animation' },
    { name: 'Embryologie 3D', query: '(3D embryology OR "embryologie 3D") development animation' },
    { name: 'G√©n√©tique Mol√©culaire', query: '(3D molecular genetics OR "g√©n√©tique mol√©culaire 3D") animation' },
    { name: 'Biologie Cellulaire 3D', query: '(3D cell biology OR "biologie cellulaire 3D") animation' },

    // SCIENCES FONDAMENTALES (Bas√© sur "Biophysique", "Chimie")
    { name: 'Biophysique 3D', query: '(3D biophysics OR "biophysique 3D") medical animation' },
    { name: 'Chimie M√©dicale 3D', query: '(3D medical chemistry OR "chimie m√©dicale 3D") animation' },
    { name: 'Chimie Organique 3D', query: '(3D organic chemistry OR "chimie organique 3D") animation' },
    { name: 'Biochimie M√©tabolique', query: '(3D metabolic biochemistry OR "biochimie m√©tabolique 3D") animation' },
    { name: 'Physique M√©dicale 3D', query: '(3D medical physics OR "physique m√©dicale 3D") animation' },

    // M√âDECINE CLINIQUE (Bas√© sur les stages et pratiques)
    { name: 'Premiers Secours 3D', query: '(3D first aid OR "premiers secours 3D") emergency animation' },
    { name: 'Sant√© Communautaire', query: '(3D community health OR "sant√© communautaire 3D") animation' },
    { name: 'Vaccinologie 3D', query: '(3D vaccinology OR "vaccinologie 3D") immunization animation' },
    { name: 'Soins Infirmiers 3D', query: '(3D nursing care OR "soins infirmiers 3D") animation' },
    { name: 'M√©decine Pr√©ventive', query: '(3D preventive medicine OR "m√©decine pr√©ventive 3D") animation' },

    // SYST√àMES ET ORGANES (Approfondissement m√©dical)
    { name: 'Syst√®me Cardio-Vasculaire', query: '(3D cardiovascular system OR "syst√®me cardio-vasculaire 3D") animation' },
    { name: 'Syst√®me Respiratoire 3D', query: '(3D respiratory system OR "syst√®me respiratoire 3D") animation' },
    { name: 'Syst√®me Digestif 3D', query: '(3D digestive system OR "syst√®me digestif 3D") animation' },
    { name: 'Syst√®me Nerveux 3D', query: '(3D nervous system OR "syst√®me nerveux 3D") animation' },
    { name: 'Syst√®me Endocrinien 3D', query: '(3D endocrine system OR "syst√®me endocrinien 3D") animation' },
    { name: 'Syst√®me Immunitaire 3D', query: '(3D immune system OR "syst√®me immunitaire 3D") animation' },
    { name: 'Syst√®me R√©nal 3D', query: '(3D renal system OR "syst√®me r√©nal 3D") animation' },

    // SP√âCIALIT√âS M√âDICALES AVANC√âES
    { name: 'Neurologie 3D', query: '(3D neurology OR "neurologie 3D") brain animation' },
    { name: 'Cardiologie 3D', query: '(3D cardiology OR "cardiologie 3D") heart animation' },
    { name: 'Pneumologie 3D', query: '(3D pulmonology OR "pneumologie 3D") lungs animation' },
    { name: 'Gastro-ent√©rologie 3D', query: '(3D gastroenterology OR "gastro-ent√©rologie 3D") animation' },
    { name: 'N√©phrologie 3D', query: '(3D nephrology OR "n√©phrologie 3D") kidney animation' },
    { name: 'H√©matologie 3D', query: '(3D hematology OR "h√©matologie 3D") blood animation' },
    { name: 'Immunologie 3D', query: '(3D immunology OR "immunologie 3D") animation' },

    // DIAGNOSTIC ET IMAGERIE
    { name: 'Radiologie 3D', query: '(3D radiology OR "radiologie 3D") medical imaging' },
    { name: 'Anatomie Pathologique', query: '(3D pathology OR "anatomie pathologique 3D") animation' },
    { name: 'Diagnostic M√©dical 3D', query: '(3D medical diagnosis OR "diagnostic m√©dical 3D") animation' },
    { name: '√âchographie 3D', query: '(3D ultrasound OR "√©chographie 3D") animation' },
    { name: 'IRM 3D', query: '(3D MRI OR "IRM 3D") magnetic resonance animation' },
    { name: 'Scanner 3D', query: '(3D CT scan OR "scanner 3D") animation' },

    // TH√âRAPEUTIQUE ET PHARMACOLOGIE
    { name: 'Pharmacologie 3D', query: '(3D pharmacology OR "pharmacologie 3D") drug mechanism' },
    { name: 'M√©canisme M√©dicaments', query: '(3D drug mechanism OR "m√©canisme m√©dicament 3D") animation' },
    { name: 'Chirurgie 3D', query: '(3D surgery OR "chirurgie 3D") procedure animation' },
    { name: 'Anesth√©siologie 3D', query: '(3D anesthesiology OR "anesth√©siologie 3D") animation' },
    { name: 'R√©animation 3D', query: '(3D resuscitation OR "r√©animation 3D") CPR animation' },

    // M√âDECINE SP√âCIALIS√âE
    { name: 'P√©diatrie 3D', query: '(3D pediatrics OR "p√©diatrie 3D") child medicine' },
    { name: 'G√©riatrie 3D', query: '(3D geriatrics OR "g√©riatrie 3D") elderly medicine' },
    { name: 'Obst√©trique 3D', query: '(3D obstetrics OR "obst√©trique 3D") pregnancy animation' },
    { name: 'Gyn√©cologie 3D', query: '(3D gynecology OR "gyn√©cologie 3D") animation' },
    { name: 'Dermatologie 3D', query: '(3D dermatology OR "dermatologie 3D") skin animation' },
    { name: 'Ophtalmologie 3D', query: '(3D ophthalmology OR "ophtalmologie 3D") eye animation' },
    { name: 'ORL 3D', query: '(3D ENT OR "ORL 3D") ear nose throat animation' },

    // HISTOIRE ET √âTHIQUE
    { name: 'Histoire M√©decine', query: '(3D medical history OR "histoire m√©decine 3D") animation' },
    { name: '√âthique M√©dicale', query: '(3D medical ethics OR "√©thique m√©dicale 3D") animation' },
    { name: 'D√©couvertes M√©dicales', query: '(3D medical discoveries OR "d√©couvertes m√©dicales 3D") animation' },

    // RECHERCHE ET M√âTHODOLOGIE
    { name: 'Biostatistiques', query: '(3D biostatistics OR "biostatistiques 3D") medical research' },
    { name: 'Recherche M√©dicale', query: '(3D medical research OR "recherche m√©dicale 3D") animation' },
    { name: 'M√©thodologie Recherche', query: '(3D research methodology OR "m√©thodologie recherche 3D") animation' },

    // PRATIQUE PROFESSIONNELLE
    { name: 'S√©minaire Pratiques', query: '(3D professional practices OR "pratiques professionnelles 3D") animation' },
    { name: 'Stage Soins', query: '(3D clinical training OR "stage soins 3D") animation' },
    { name: 'Situation Int√©gration', query: '(3D integration situation OR "situation int√©gration 3D") medical' },

    // URGENCES ET SOINS CRITIQUES
    { name: 'M√©decine Urgence', query: '(3D emergency medicine OR "m√©decine urgence 3D") animation' },
    { name: 'Soins Intensifs', query: '(3D intensive care OR "soins intensifs 3D") animation' },
    { name: 'Traumatologie 3D', query: '(3D traumatology OR "traumatologie 3D") animation' },

    // M√âDECINE EXP√âRIMENTALE
    { name: 'Physiologie 3D', query: '(3D physiology OR "physiologie 3D") animation' },
    { name: 'Pathophysiologie', query: '(3D pathophysiology OR "pathophysiologie 3D") animation' },
    { name: 'Bio-m√©canique 3D', query: '(3D biomechanics OR "bio-m√©canique 3D") animation' },
    { name: 'G√©n√©tique M√©dicale', query: '(3D medical genetics OR "g√©n√©tique m√©dicale 3D") animation' }
];
        
        // Th√®mes
        const themes = {
            dark: {
                background: '#0a192f',
                text: '#e6f1ff',
                secondaryText: '#8892b0',
                accent: '#64ffda',
                cardBackground: '#112240',
                border: '#1e3a5c'
            },
            light: {
                background: '#f5f7fa',
                text: '#2d3748',
                secondaryText: '#4a5568',
                accent: '#3182ce',
                cardBackground: '#ffffff',
                border: '#e2e8f0'
            }
        };
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Correction layout Android
            fixAndroidLayout();
            
            // Charger l'historique des vid√©os visionn√©es
            loadWatchedVideos();
            
            // Charger le cache des vid√©os
            loadVideoCache();
            
            // Initialiser les filtres
            initFilters();
            
            // Charger les vid√©os initiales
            loadVideos(currentQuery);
            
            // √âcouter la recherche
            searchInput.addEventListener('input', debounce(function() {
                const query = searchInput.value.trim();
                if (query) {
                    currentQuery = `(${query}) (3D OR "animation 3D") (medical OR m√©decine OR science) -real -actual -surgery -live -vlog`;
                    isUsingCache = false;
                    cacheIndicator.style.display = 'none';
                    videosContainer.innerHTML = '<div class="loading pulse">Recherche de vid√©os 3D scientifiques...</div>';
                    loadVideos(currentQuery);
                } else {
                    currentQuery = '(3D medical animation OR "animation 3D m√©dicale") (science OR scientifique) -"real" -"actual" -"surgery" -"live" -"vlog"';
                    isUsingCache = false;
                    cacheIndicator.style.display = 'none';
                    loadVideos(currentQuery);
                }
            }, 800));
            
            // √âcouter le d√©filement
            videosContainer.addEventListener('scroll', function() {
                if (videosContainer.scrollTop + videosContainer.clientHeight >= videosContainer.scrollHeight - 100) {
                    loadMoreVideos();
                }
                handleVideoPlayback();
            });
            
            // √âcouter le changement de th√®me
            themeToggle.addEventListener('click', toggleTheme);
            
            // Observer les changements de visibilit√©
            initIntersectionObserver();
            
            // √âcouter les changements d'orientation
            window.addEventListener('orientationchange', function() {
                setTimeout(fixAndroidLayout, 300);
            });
        });
        
        // Fonction pour obtenir la cl√© API actuelle
        function getCurrentApiKey() {
            return API_KEYS[currentApiKeyIndex];
        }
        
        // Fonction pour passer √† la cl√© API suivante
        function rotateApiKey() {
            currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
            apiErrorCount = 0;
            updateApiStatus();
            console.log(`Rotation vers la cl√© API #${currentApiKeyIndex + 1}`);
        }
        
        // Mettre √† jour l'affichage du statut API
        function updateApiStatus() {
            apiStatus.textContent = `Cl√© API: #${currentApiKeyIndex + 1}/${API_KEYS.length} Active`;
        }
        
        // Correction layout Android
        function fixAndroidLayout() {
            const isAndroid = /Android/.test(navigator.userAgent);
            
            if (isAndroid) {
                const header = document.querySelector('.header');
                const searchContainer = document.querySelector('.search-container');
                
                if (header && searchContainer) {
                    setTimeout(() => {
                        header.style.transform = 'translateZ(0)';
                        searchContainer.style.transform = 'translateZ(0)';
                        void header.offsetHeight;
                        void searchContainer.offsetHeight;
                    }, 100);
                }
            }
        }
        
        // Charger l'historique des vid√©os visionn√©es
        function loadWatchedVideos() {
            const saved = localStorage.getItem('watchedVideos');
            if (saved) {
                watchedVideos = new Set(JSON.parse(saved));
            }
        }
        
        // Sauvegarder l'historique
        function saveWatchedVideos() {
            localStorage.setItem('watchedVideos', JSON.stringify([...watchedVideos]));
        }
        
        // Charger le cache des vid√©os
        function loadVideoCache() {
            const savedCache = localStorage.getItem('videoCache');
            if (savedCache) {
                allVideosCache = JSON.parse(savedCache);
            }
        }
        
        // Sauvegarder le cache
        function saveVideoCache() {
            localStorage.setItem('videoCache', JSON.stringify(allVideosCache));
        }
        
        // Mettre √† jour le cache
        function updateVideoCache(newVideos) {
            let cacheUpdated = false;
            
            newVideos.forEach(video => {
                const exists = allVideosCache.some(cachedVideo => 
                    cachedVideo.id.videoId === video.id.videoId
                );
                if (!exists) {
                    allVideosCache.push(video);
                    cacheUpdated = true;
                }
            });
            
            if (cacheUpdated) {
                // Garder seulement les 200 derni√®res vid√©os
                if (allVideosCache.length > 200) {
                    allVideosCache = allVideosCache.slice(-200);
                }
                saveVideoCache();
            }
        }
        
        // Obtenir les vid√©os √† afficher
        function getVideosToDisplay(currentVideos) {
            const unwatchedVideos = currentVideos.filter(video => 
                !watchedVideos.has(video.id.videoId)
            );
            
            if (unwatchedVideos.length === 0 && allVideosCache.length > 0) {
                isUsingCache = true;
                cacheIndicator.style.display = 'block';
                
                const shuffledCache = [...allVideosCache].sort(() => Math.random() - 0.5);
                const unwatchedFromCache = shuffledCache.filter(video => 
                    !watchedVideos.has(video.id.videoId)
                );
                
                if (unwatchedFromCache.length > 0) {
                    return unwatchedFromCache.slice(0, Math.min(currentVideos.length, unwatchedFromCache.length));
                } else {
                    return shuffledCache.slice(0, Math.min(currentVideos.length, shuffledCache.length));
                }
            } else {
                isUsingCache = false;
                cacheIndicator.style.display = 'none';
                return unwatchedVideos;
            }
        }
        
        // Initialiser l'Intersection Observer
        function initIntersectionObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const videoId = entry.target.getAttribute('data-video-id');
                        if (videoId && videoId !== currentVideoId) {
                            stopCurrentVideo();
                            currentVideoId = videoId;
                            
                            if (!watchedVideos.has(videoId)) {
                                watchedVideos.add(videoId);
                                saveWatchedVideos();
                            }
                        }
                    }
                });
            }, {
                threshold: 0.7
            });
            
            window.videoObserver = observer;
        }
        
        // Arr√™ter la vid√©o actuelle
        function stopCurrentVideo() {
            if (currentVideoId) {
                const iframe = document.querySelector(`iframe[data-video-id="${currentVideoId}"]`);
                if (iframe) {
                    const currentSrc = iframe.src;
                    iframe.src = currentSrc.split('?')[0] + '?autoplay=0';
                }
                currentVideoId = null;
            }
        }
        
        // G√©rer la lecture des vid√©os
        function handleVideoPlayback() {
            const videoCards = document.querySelectorAll('.video-card');
            let mostVisibleVideo = null;
            let maxVisibility = 0;
            
            videoCards.forEach(card => {
                const rect = card.getBoundingClientRect();
                const containerRect = videosContainer.getBoundingClientRect();
                
                const visibleHeight = Math.min(rect.bottom, containerRect.bottom) - Math.max(rect.top, containerRect.top);
                const visibilityRatio = visibleHeight / rect.height;
                
                if (visibilityRatio > maxVisibility) {
                    maxVisibility = visibilityRatio;
                    mostVisibleVideo = card;
                }
            });
            
            if (mostVisibleVideo && maxVisibility > 0.7) {
                const videoId = mostVisibleVideo.getAttribute('data-video-id');
                if (videoId && videoId !== currentVideoId) {
                    stopCurrentVideo();
                    currentVideoId = videoId;
                    
                    if (!watchedVideos.has(videoId)) {
                        watchedVideos.add(videoId);
                        saveWatchedVideos();
                    }
                }
            }
        }
        
        // Initialiser les filtres
        function initFilters() {
            medicalFilters.forEach(filter => {
                const button = document.createElement('button');
                button.className = 'filter-btn';
                button.textContent = filter.name;
                button.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                    currentQuery = filter.query;
                    isUsingCache = false;
                    cacheIndicator.style.display = 'none';
                    videosContainer.innerHTML = '<div class="loading pulse">Chargement de contenu 3D scientifique...</div>';
                    loadVideos(filter.query);
                });
                filtersContainer.appendChild(button);
            });
        }
        
        // Fonction pour charger les vid√©os
        async function loadVideos(query) {
            isLoading = true;
            nextPageToken = '';
            
            try {
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&videoEmbeddable=true&maxResults=15&key=${getCurrentApiKey()}`
                );
                
                if (!response.ok) {
                    if (response.status === 403) {
                        // Quota exceeded - rotate API key
                        apiErrorCount++;
                        if (apiErrorCount >= MAX_API_ERRORS) {
                            throw new Error('QUOTA_EXCEEDED');
                        }
                    }
                    throw new Error(`Erreur API: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    if (data.error.code === 403) {
                        throw new Error('QUOTA_EXCEEDED');
                    }
                    throw new Error(data.error.message);
                }
                
                if (data.items && data.items.length > 0) {
                    // Filtrer les vid√©os de qualit√©
                    const qualityVideos = data.items.filter(video => 
                        isQualityVideo(video.snippet.title, video.snippet.description)
                    );
                    
                    if (qualityVideos.length > 0) {
                        updateVideoCache(qualityVideos);
                        const videosToDisplay = getVideosToDisplay(qualityVideos);
                        
                        if (videosToDisplay.length > 0) {
                            displayVideos(videosToDisplay);
                        } else {
                            showNoNewVideos();
                        }
                    } else {
                        showNoQualityVideos();
                    }
                    
                    nextPageToken = data.nextPageToken || '';
                    apiErrorCount = 0; // Reset error count on success
                } else {
                    handleNoVideosFound();
                }
                
                isLoading = false;
                
            } catch (error) {
                console.error('Erreur lors du chargement des vid√©os:', error);
                
                if (error.message === 'QUOTA_EXCEEDED' || error.message.includes('quota')) {
                    if (API_KEYS.length > 1) {
                        rotateApiKey();
                        // R√©essayer avec la nouvelle cl√©
                        setTimeout(() => loadVideos(query), 1000);
                        return;
                    } else {
                        videosContainer.innerHTML = '<div class="error-message">Limite de requ√™tes API atteinte. R√©essayez plus tard.</div>';
                    }
                } else {
                    handleLoadError();
                }
                
                isLoading = false;
            }
        }
        
        // V√©rifier si c'est une vid√©o de qualit√© (3D/scientifique)
        function isQualityVideo(title, description) {
            const text = (title + ' ' + description).toLowerCase();
            
            // Mots-cl√©s positifs (3D et scientifique)
            const positiveKeywords = [
                '3d', 'three-dimensional', 'animation', 'animated',
                'medical', 'medicine', 'm√©decine', 'scientific', 'science',
                'anatomy', 'anatomie', 'biology', 'biologie', 'molecular',
                'cell', 'cellule', 'dna', 'adn', 'protein', 'prot√©ine',
                'heart', 'c≈ìur', 'brain', 'cerveau', 'neuron', 'neurone',
                'virus', 'bacteria', 'bact√©rie', 'immunology', 'immunologie'
            ];
            
            // Mots-cl√©s n√©gatifs (√† √©viter)
            const negativeKeywords = [
                'real surgery', 'actual patient', 'live surgery', 'vlog',
                'blog', 'tutorial', 'lecture', 'course', 'class', 'lesson',
                'review', 'reaction', 'mockup', 'fake', 'faux'
            ];
            
            const hasPositive = positiveKeywords.some(keyword => text.includes(keyword));
            const hasNegative = negativeKeywords.some(keyword => text.includes(keyword));
            
            return hasPositive && !hasNegative;
        }
        
        // Charger plus de vid√©os
        async function loadMoreVideos() {
            if (isLoading || !nextPageToken) return;
            
            isLoading = true;
            loadingIndicator.style.display = 'block';
            
            try {
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(currentQuery)}&type=video&videoEmbeddable=true&maxResults=10&pageToken=${nextPageToken}&key=${getCurrentApiKey()}`
                );
                
                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const qualityVideos = data.items.filter(video => 
                        isQualityVideo(video.snippet.title, video.snippet.description)
                    );
                    
                    if (qualityVideos.length > 0) {
                        updateVideoCache(qualityVideos);
                        const videosToDisplay = getVideosToDisplay(qualityVideos);
                        
                        if (videosToDisplay.length > 0) {
                            appendVideos(videosToDisplay);
                        }
                    }
                    
                    nextPageToken = data.nextPageToken || '';
                }
                
                isLoading = false;
                loadingIndicator.style.display = 'none';
                
            } catch (error) {
                console.error('Erreur lors du chargement des vid√©os suppl√©mentaires:', error);
                isLoading = false;
                loadingIndicator.style.display = 'none';
            }
        }
        
        // Afficher les vid√©os
        function displayVideos(videos) {
            if (videos.length === 0) {
                showNoNewVideos();
                return;
            }
            
            videosContainer.innerHTML = '';
            
            videos.forEach(video => {
                const videoCard = createVideoCard(video);
                videosContainer.appendChild(videoCard);
            });
            
            videosContainer.appendChild(loadingIndicator);
            loadingIndicator.style.display = 'none';
        }
        
        // Ajouter des vid√©os
        function appendVideos(videos) {
            videos.forEach(video => {
                const videoCard = createVideoCard(video);
                videosContainer.appendChild(videoCard);
            });
        }
        
        // Cr√©er une carte vid√©o
        function createVideoCard(video) {
            const videoCard = document.createElement('div');
            videoCard.className = 'video-card';
            videoCard.setAttribute('data-video-id', video.id.videoId);
            
            const isScientific = isQualityVideo(video.snippet.title, video.snippet.description);
            const qualityBadge = isScientific ? '<span class="quality-badge">üî¨ 3D Scientifique</span>' : '';
            
            videoCard.innerHTML = `
                <div class="video-wrapper">
                    <div class="video-player">
                        <iframe src="https://www.youtube.com/embed/${video.id.videoId}?autoplay=0&modestbranding=1" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen
                                data-video-id="${video.id.videoId}">
                        </iframe>
                    </div>
                    <div class="video-info">
                        <h3 class="video-title">${video.snippet.title} ${qualityBadge}</h3>
                        ${isUsingCache ? '<div style="font-size: 0.8rem; color: #64ffda; margin-top: 5px;">üì¶ Vid√©o du cache</div>' : ''}
                    </div>
                </div>
            `;
            
            if (window.videoObserver) {
                window.videoObserver.observe(videoCard);
            }
            
            return videoCard;
        }
        
        // Gestion des erreurs et √©tats vides
        function showNoNewVideos() {
            videosContainer.innerHTML = `
                <div class="no-results">
                    <h3>üéØ Toutes les nouvelles vid√©os ont √©t√© visionn√©es</h3>
                    <p>Essayez d'autres filtres ou termes de recherche pour d√©couvrir plus de contenu 3D scientifique.</p>
                </div>
            `;
        }
        
        function showNoQualityVideos() {
            videosContainer.innerHTML = `
                <div class="no-results">
                    <h3>üîç Aucune vid√©o 3D scientifique trouv√©e</h3>
                    <p>Les r√©sultats ne correspondent pas aux crit√®res de qualit√©. Essayez d'autres termes.</p>
                </div>
            `;
        }
        
        function handleNoVideosFound() {
            if (allVideosCache.length > 0) {
                isUsingCache = true;
                cacheIndicator.style.display = 'block';
                const shuffledCache = [...allVideosCache].sort(() => Math.random() - 0.5);
                displayVideos(shuffledCache.slice(0, 10));
            } else {
                videosContainer.innerHTML = `
                    <div class="no-results">
                        <h3>üîç Aucune vid√©o trouv√©e</h3>
                        <p>Essayez d'autres termes de recherche ou filtres pour d√©couvrir du contenu 3D m√©dical.</p>
                    </div>
                `;
            }
        }
        
        function handleLoadError() {
            if (allVideosCache.length > 0) {
                isUsingCache = true;
                cacheIndicator.style.display = 'block';
                const shuffledCache = [...allVideosCache].sort(() => Math.random() - 0.5);
                displayVideos(shuffledCache.slice(0, 10));
            } else {
                videosContainer.innerHTML = '<div class="error-message">Erreur lors du chargement. V√©rifiez votre connexion.</div>';
            }
        }
        
        // Changer le th√®me
        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
            themeToggle.textContent = currentTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }
        
        // Appliquer le th√®me
        function applyTheme(theme) {
            const colors = themes[theme];
            
            document.body.style.backgroundColor = colors.background;
            document.body.style.color = colors.text;
            
            const elementsToUpdate = {
                '.header': ['backgroundColor', 'borderBottomColor'],
                '.search-input': ['backgroundColor', 'color', 'borderColor'],
                '.video-card': ['backgroundColor'],
                '.video-info': ['backgroundColor'],
                '.filter-btn': ['backgroundColor', 'color', 'borderColor']
            };
            
            Object.entries(elementsToUpdate).forEach(([selector, properties]) => {
                document.querySelectorAll(selector).forEach(element => {
                    properties.forEach(property => {
                        if (property.includes('Color')) {
                            const colorType = property.replace('Color', '').toLowerCase();
                            element.style[property] = colors[colorType] || colors[property] || colors.border;
                        }
                    });
                });
            });
        }
        
        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>